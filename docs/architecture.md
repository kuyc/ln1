1. Назначение документа

Этот документ определяет архитектуру проекта ln1.

Он описывает:

состав системы;

границы модулей;

ответственность компонентов;

правила взаимодействия.

Если реализация противоречит этому документу —
➡️ реализация считается ошибочной.

2. Архитектурный принцип проекта

ln1 построен как модульная, управляемая, событийная система
с центральным Workflow Engine.

Ключевой принцип

Нет прямых действий.
Любое действие — часть Workflow.

3. Общая архитектурная схема (логическая)
Telegram Bot (UI)
        ↓
Workflow Engine (State Machine)
        ↓
 ┌───────────────┬────────────────┬─────────────────┐
 │               │                │                 │
Playerok API   AI Services   Pricing Engine   Data Layer


Ни один компонент не может обходить Workflow Engine.

4. Корневая структура проекта

Единственная допустимая структура:

ln1/
 ├── docs/        # нормативная документация
 ├── src/         # код бота
 ├── tests/       # тесты
 ├── README.md
 └── .env.example

5. Основные модули системы
5.1 Telegram Bot (UI Layer)

Ответственность:

приём команд;

кнопки;

отображение статусов;

подтверждения администратора.

Ограничения:

не содержит бизнес-логики;

не вызывает API напрямую;

не принимает решений.

Telegram Bot → ТОЛЬКО триггер Workflow.

5.2 Workflow Engine (ЯДРО СИСТЕМЫ)

Центральный компонент ln1.

Ответственность:

управление состояниями;

переходы между этапами;

контроль режимов;

остановка при ошибках.

Workflow Engine реализуется как State Machine.

Примеры состояний:

INIT

DATA_COLLECTION

CONTENT_GENERATION

ADMIN_CONFIRMATION

PUBLISHING

WAIT_FOR_SALE

POST_SALE

STOPPED

ERROR

❗ Ни один модуль не может изменить состояние напрямую.

5.3 Playerok Integration

Ответственность:

работа с Playerok API через cookies;

публикация товаров;

получение заказов;

подтверждение заказов;

получение рыночных данных.

Ограничения:

не содержит бизнес-логики;

не знает о режимах;

не инициирует действия.

Работает только по запросу Workflow Engine.

5.4 AI Services

Ответственность:

генерация текста;

генерация изображений;

аналитика.

Ограничения:

не управляет процессами;

не знает о режиме;

не имеет доступа к API Playerok напрямую.

Все вызовы AI проходят через Workflow Engine.

5.5 Pricing Engine

Ответственность:

расчёт цены;

анализ спроса;

динамическая корректировка.

Ограничения:

не публикует товары;

не меняет цену напрямую;

работает только в рамках лимитов.

Решения Pricing Engine могут быть отклонены Workflow Engine.

5.6 Data Layer

Ответственность:

хранение истории товаров;

хранение цен;

логи действий;

результаты продаж;

данные для обучения.

Ограничения:

не содержит логики;

не принимает решений.

6. Поток управления (Control Flow)
Канонический поток
User / Admin
 ↓
Telegram Bot
 ↓
Workflow Engine
 ↓
[один или несколько модулей]
 ↓
Workflow Engine
 ↓
Следующее состояние или STOP

7. Управление режимами

Режимы (Semi / Auto):

определяются при старте Workflow;

не могут быть изменены «на лету»;

влияют на разрешённые переходы состояний.

Подробно — в modes.md.

8. Обработка ошибок
Любая ошибка:

фиксируется;

переводит Workflow в состояние ERROR;

уведомляет администратора;

блокирует продолжение без решения человека.

9. Безопасность и ограничения

Архитектурно запрещено:

прямое обращение к Playerok API из UI;

параллельные Workflow без контроля;

вызовы AI вне Workflow;

самовосстановление без подтверждения.

10. Тестируемость архитектуры

Каждый модуль:

может быть протестирован отдельно;

имеет чёткий интерфейс;

допускает mock-реализации.

11. Эволюция архитектуры

Архитектура:

допускает расширение модулей;

допускает добавление новых Workflow;

не допускает обход ядра системы.

Любые изменения:

сначала описываются в docs;

затем реализуются;

затем тестируются.

12. Финальное правило архитектуры

Workflow Engine — единственный центр управления.
Всё остальное — исполнители.
