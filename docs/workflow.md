1. Назначение документа

Этот документ описывает Workflow Engine проекта ln1:

состояния;

переходы;

сценарии выполнения;

правила остановки.

Workflow — единственный допустимый способ выполнения действий в системе.

Если действие происходит вне Workflow —
➡️ это ошибка архитектуры.

2. Что такое Workflow Engine

Workflow Engine — это централизованная машина состояний (State Machine),
которая управляет жизненным циклом товара на Playerok.

Он:

контролирует порядок действий;

ограничивает автономность;

предотвращает опасные сценарии;

обеспечивает воспроизводимость.

3. Общие правила Workflow (НЕ НАРУШАЮТСЯ)

Workflow запускается только администратором

Workflow всегда начинается с INIT

Workflow всегда заканчивается в STOPPED или ERROR

Одно действие = одно состояние

Ошибка в любом состоянии → ERROR

Нет «пропуска» состояний

4. Список состояний Workflow (КАНОНИЧЕСКИЙ)
INIT
DATA_COLLECTION
CONTENT_GENERATION
PRICE_CALCULATION
ADMIN_CONFIRMATION
PUBLISHING
WAIT_FOR_SALE
POST_SALE
RELIST (только Auto)
STOPPED
ERROR

5. Описание состояний
5.1 INIT

Назначение:
Инициализация Workflow.

Действия:

загрузка режима (Semi / Auto);

проверка лимитов;

проверка доступности API;

проверка данных.

❌ Любая ошибка → ERROR

5.2 DATA_COLLECTION

Назначение:
Сбор данных о рынке Playerok.

Действия:

анализ аналогичных товаров;

сбор цен;

сбор описаний;

обновление базы.

❌ Ошибка → ERROR

5.3 CONTENT_GENERATION

Назначение:
Генерация контента товара.

Действия:

генерация названия;

генерация описания;

генерация комментария;

генерация превью изображения.

❌ Невалидный результат → ERROR

5.4 PRICE_CALCULATION

Назначение:
Определение стартовой цены.

Действия:

расчёт через Pricing Engine;

проверка лимитов;

сохранение результата.

❌ Выход за лимиты → ERROR

5.5 ADMIN_CONFIRMATION

Назначение:
Контроль администратора.

Действия:

показ контента;

показ цены;

запрос подтверждения.

Варианты перехода:

подтверждено → PUBLISHING

отклонено → STOPPED

❗ В Auto режиме:

подтверждение требуется только для первого цикла

5.6 PUBLISHING

Назначение:
Публикация товара на Playerok.

Действия:

публикация через Playerok API;

логирование.

❌ Ошибка → ERROR

5.7 WAIT_FOR_SALE

Назначение:
Ожидание продажи.

Действия:

мониторинг заказов;

мониторинг спроса;

возможная корректировка цены (через Pricing Engine).

❌ Критическая ошибка → ERROR

5.8 POST_SALE

Назначение:
Обработка продажи.

Действия:

ответ клиенту шаблоном;

подтверждение заказа;

логирование результата.

❌ Ошибка → ERROR

5.9 RELIST (ТОЛЬКО Auto)

Назначение:
Перевыставление товара.

Действия:

корректировка цены;

переход к DATA_COLLECTION.

❌ Ошибка → ERROR

5.10 STOPPED

Назначение:
Корректное завершение Workflow.

Причины:

отклонение администратором;

завершение Semi режима;

ручная остановка.

5.11 ERROR

Назначение:
Аварийное завершение Workflow.

Действия:

остановка всех процессов;

сохранение состояния;

уведомление администратора.

❌ Автовосстановление запрещено

6. Workflow по режимам
6.1 Semi-Auto Workflow
INIT
 → DATA_COLLECTION
 → CONTENT_GENERATION
 → PRICE_CALCULATION
 → ADMIN_CONFIRMATION
 → PUBLISHING
 → WAIT_FOR_SALE
 → POST_SALE
 → STOPPED

6.2 Auto Workflow
INIT
 → DATA_COLLECTION
 → CONTENT_GENERATION
 → PRICE_CALCULATION
 → ADMIN_CONFIRMATION (1 раз)
 → PUBLISHING
 → WAIT_FOR_SALE
 → POST_SALE
 → RELIST
 → DATA_COLLECTION
 → ...

7. Управление ценой внутри Workflow

изменение цены разрешено только в WAIT_FOR_SALE;

цена всегда проверяется лимитами;

резкие изменения запрещены.

Подробности — в pricing.md.

8. Kill Switch (обязательно)

В любой момент администратор может:

остановить текущий Workflow;

перевести систему в STOPPED.

Kill Switch:

имеет приоритет над всеми состояниями;

не может быть проигнорирован.

9. Логирование Workflow

Логируется:

каждое состояние;

каждый переход;

причины ошибок;

подтверждения администратора.

Без логов Workflow считается некорректным.

10. Финальное правило Workflow

Если ты не можешь описать действие как состояние —
этого действия не должно быть в системе.
